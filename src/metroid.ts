const map = {
    "name": "Brinstar",
    "backWidth": 15,
    "backHeight": 16,
    "backdata": [
        [0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0],
        [0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0],
        [3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 3],
        [0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 0, 0, 0],
        [0, 0, 0, 3, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 3, 3, 3, 0, 0],
        [0, 0, 0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 3, 0, 0, 3],
        [3, 0, 0, 0, 3, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0],
        [3, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
        [0, 3, 0, 0, 0, 3, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0],
        [0, 0, 0, 0, 0, 0, 3, 0, 0, 0, 0, 0, 0, 0, 3, 0]
    ],
    "width": 32,
    "height": 20,
    "data": [
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1],
        [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 2, 2, 2, 2, 2, 2, 2],
        [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1],
        [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
        [2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2]
    ]
}

// Camera Canvas Dimensions in blocks
const cameraBlockWitdh = 16;
const cameraBlockHeight = 15;
// Camera Block Dimensions in pixels
const blockWitdh = 32;
const blockHeight = 32;
// Camera Canvas Dimensions in pixels
const cameraWitdh = cameraBlockWitdh * blockWitdh;
const cameraHeight = cameraBlockHeight * blockHeight;
// Camera speed in Pixels per second
const cameraSpeed = 512;

// Camera
let cameraX = 0;
let cameraY = 0;
let hasScrolled = false;

// Frames
let totalElapsed = 0;
let frameCounter = 0;
let previousElapsed = 0;

// Variables
let images;
let camCanvas, frontCanvas, backCanvas;
let camctx, frontctx, backctx;
let keyboard;
let zoomers;
let zoomerImage;
let config;

window.onload = () => {
    //
    // Keyboard Listener
    //
    keyboard = new Keyboard();
    keyboard.listenForEvents([keyboard.LEFT, keyboard.RIGHT, keyboard.UP, keyboard.DOWN]);
    //
    // Images
    //
    let img0 = document.getElementById("block_0");
    let img1 = document.getElementById("block_1");
    let img2 = document.getElementById("block_2");
    let img3 = document.getElementById("block_3");
    zoomerImage = document.getElementById("zoomer");
    images = [img0, img1, img2, img3];
    //
    // Config
    //
    let c1 = document.getElementById("c1");
    let c2 = document.getElementById("c2");
    let c3 = document.getElementById("c3");
    let c4 = document.getElementById("c4");
    let c5 = document.getElementById("c5");
    config = new Config();
    config.add("background", c1);
    config.add("map", c2);
    config.add("zoomers", c3);
    config.add("FPS", c4);
    config.add("grid", c5);
    //
    // Zoomer
    //
    let zoomer, zoomer1, zoomer2, zoomer3, zoomer4, zoomer5;
    zoomer = new Zoomer();
    zoomer.spawn(map.data, zoomer.COUNTERCLOCK, zoomer.TOP, 9, 4);
    zoomer1 = new Zoomer();
    zoomer1.spawn(map.data, zoomer1.CLOCK, zoomer1.DOWN, 9, 12);
    zoomer2 = new Zoomer();
    zoomer2.spawn(map.data, zoomer2.CLOCK, zoomer2.TOP, 19, 4);
    zoomer3 = new Zoomer();
    zoomer3.spawn(map.data, zoomer3.CLOCK, zoomer3.DOWN, 19, 17);
    zoomer4 = new Zoomer();
    zoomer4.spawn(map.data, zoomer4.CLOCK, zoomer4.RIGHT, 29, 8);
    zoomer5 = new Zoomer();
    zoomer5.spawn(map.data, zoomer5.CLOCK, zoomer5.LEFT, 1, 8);
    zoomers = [zoomer, zoomer1, zoomer2, zoomer3, zoomer4, zoomer5];
    //
    // Camera context
    //
    camCanvas = document.getElementById("metroidCanvas");
    camCanvas.width = cameraWitdh;
    camCanvas.height = cameraHeight;
    camctx = camCanvas.getContext("2d");
    camctx.fillStyle = "white";
    camctx.strokeStyle = "red";
    //
    // Front layer context
    //
    frontCanvas = document.createElement('canvas');
    frontCanvas.width = cameraWitdh;
    frontCanvas.height = cameraHeight;
    frontctx = frontCanvas.getContext("2d");
    //
    // Background layer context
    //
    backCanvas = document.createElement('canvas');
    backCanvas.width = cameraWitdh;
    backCanvas.height = cameraHeight;
    backctx = backCanvas.getContext("2d");
    //
    // Render layers off screen
    //
    renderLayer(frontctx, map.data, map.height, map.width, true);
    renderLayer(backctx, map.backdata, map.backHeight, map.backWidth, false);
    //
    // Draw layers in main canvas
    //
    camctx.drawImage(backCanvas, 0, 0);
    camctx.drawImage(frontCanvas, 0, 0);
    //
    // Register for next frame rendering callback
    //
    window.requestAnimationFrame(prepareNextFrame);
    //
    // Call interval for fps display
    //
    //setInterval(displayFrameRate, 5000);
}

function displayFrameRate() {
    let element = document.getElementById("framerate");
    if (element && (totalElapsed != 0)) {
        let frameRate = frameCounter / totalElapsed;
        element.innerHTML =
            Math.round(frameRate) + " fps" +
            " (" + Math.round(totalElapsed) + " seconds, " + frameCounter + " frames)";
    }
    setInterval(displayFrameRate, 5000);
}

function prepareNextFrame(elapsed) {
    //
    // Register function again for next frame rendering callback
    //
    window.requestAnimationFrame(prepareNextFrame);
    //
    // Compute delta time in seconds since last frame
    // and cap it to 250ms (0.25s)
    //
    let delta = (elapsed - previousElapsed) / 1000.0;
    delta = Math.min(delta, 0.25);
    previousElapsed = elapsed;
    totalElapsed += delta;
    frameCounter += 1;
    //
    // Update Camera and zoomers Coordinates
    //
    moveCamera(delta);
    for (const z of zoomers) {
        z.move(0);
    }
    //
    // Render layers
    //
    renderGame();
}

function moveCamera(delta) {
    hasScrolled = false;
    //
    // determine camera movement from arrow keys pressed
    //
    let dirX = 0;
    let dirY = 0;
    if (keyboard.isDown(keyboard.LEFT)) { dirX = -1; }
    if (keyboard.isDown(keyboard.RIGHT)) { dirX = 1; }
    if (keyboard.isDown(keyboard.UP)) { dirY = -1; }
    if (keyboard.isDown(keyboard.DOWN)) { dirY = 1; }
    if (dirX !== 0 || dirY !== 0) {
        //
        // Move Camera
        //
        // Camera moves 512 pixels per second
        // 
        // if 0.25 seconds passed since last frame then move 128 pixels
        // if 0.10 seconds passed since last frame then move 51 pixels
        // if 0.03 seconds passed since last frame then move 17 pixels
        // if 0.01 seconds passed since last frame then move 8 pixels
        //
        //   FPS   1 Frame every                camera move
        //   ===   ========================     ===========
        //   60    0.0166 second - 16 ms        8 pixels
        //   30    0.0333 second - 33 ms        17 pixels
        //   10    0.1 second    - 100 ms       51 pixels
        //    4    0.25 second   - 250 ms       128 pixels
        //
        cameraX += dirX * cameraSpeed * delta;
        cameraY += dirY * cameraSpeed * delta;
        //
        // Bound camera coordinates
        //
        let maxValidCameraX = map.width * blockWitdh - cameraWitdh ;
        let maxValidCameraY = map.height * blockHeight - cameraHeight;
        cameraX = Math.max(0, Math.min(cameraX, maxValidCameraX));
        cameraY = Math.max(0, Math.min(cameraY, maxValidCameraY));
        hasScrolled = true;
    }
}

function renderGame() {
    //
    // render map layer(s) if there has been scroll
    //
    if (hasScrolled || config.check("grid")) {
        renderLayer(frontctx, map.data, map.width, map.height, true);
    }
    //
    // draw the map layer(s) into game canvas
    //
    if (config.check("background")) {
        camctx.drawImage(backCanvas, 0, 0);
    } else {
        camctx.clearRect(0, 0, cameraWitdh, cameraHeight);
    }
    if (config.check("map")) {
        camctx.drawImage(frontCanvas, 0, 0);
    }
    //
    // draw zoomer(s) sprites into game canvas
    //
    // [ToDo] Render only if on screen
    //
    if (config.check("zoomers")) {
        for (const z of zoomers) {
            camctx.drawImage(zoomerImage, z.x - cameraX, z.y - cameraY);
        }
    }
    if (config.check("FPS")) {
        //
        // FPS
        //
        camctx.font = "20px Arial";
        if (totalElapsed != 0) {
            let frameRate = frameCounter / totalElapsed;
            camctx.fillText(Math.round(frameRate) + " fps", 10, 20);
        }
    }
}

function renderLayer(context, mapData, width, height, transparency) {
    if (transparency) {
        context.clearRect(0, 0, cameraWitdh, cameraHeight);
    }
    let firstBlockX = Math.floor(cameraX / blockWitdh);
    let firstBlockY = Math.floor(cameraY / blockHeight);
    let drawPosOffsetX = cameraX % blockWitdh;
    let drawPosOffsetY = cameraY % blockHeight;
    context.fillStyle = "lightgray";
    context.strokeStyle = "gray";
    context.font = "10px Arial";
    for (let i = firstBlockY; i <= firstBlockY + cameraBlockHeight; i++) {
        for (let j = firstBlockX; j <= firstBlockX + cameraBlockWitdh; j++) {
            if ((j < width) && (i < height)) {
                let x = Math.floor(((j - firstBlockX) * blockWitdh) - drawPosOffsetX);
                let y = Math.floor(((i - firstBlockY) * blockHeight) - drawPosOffsetY);
                if (!((mapData[i][j] == 0) && transparency)) {
                    context.drawImage(images[mapData[i][j]], x, y);
                }
                if (config.check("grid")) {
                    context.strokeRect(x, y, blockWitdh, blockHeight);
                    context.fillText(i + "," + j, x + 3, y + 10);
                }
            }
        }
    }
}